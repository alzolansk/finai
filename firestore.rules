rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ Helper Functions ============
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate transaction data structure
    function isValidTransaction(data) {
      return data.keys().hasAll(['description', 'amount', 'date', 'type', 'category'])
        && data.amount is number
        && data.amount >= 0
        && data.amount <= 999999999
        && data.description is string
        && data.description.size() <= 200
        && data.type in ['INCOME', 'EXPENSE'];
    }
    
    // Validate settings data structure
    function isValidSettings(data) {
      return data.monthlyIncome is number
        && data.monthlyIncome >= 0
        && data.savingsGoal is number
        && data.savingsGoal >= 0;
    }
    
    // Rate limiting - max 100 writes per minute per user
    // Note: This is a simplified check, real rate limiting should use Cloud Functions
    function notRateLimited() {
      return true; // Implement with Cloud Functions for production
    }
    
    // ============ User Data Rules ============
    
    // User's private data - only accessible by the owner
    match /users/{userId} {
      // Allow reading user document
      allow read: if isOwner(userId);
      
      // Transactions collection
      match /transactions/{transactionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) 
          && notRateLimited()
          && isValidTransaction(request.resource.data);
        allow update: if isOwner(userId) 
          && notRateLimited()
          && isValidTransaction(request.resource.data);
        allow delete: if isOwner(userId);
      }
      
      // User settings
      match /config/settings {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) 
          && notRateLimited()
          && isValidSettings(request.resource.data);
      }
      
      // Wishlist items
      match /wishlist/{itemId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) 
          && notRateLimited()
          && request.resource.data.name is string
          && request.resource.data.targetAmount is number;
        allow update: if isOwner(userId) && notRateLimited();
        allow delete: if isOwner(userId);
      }
      
      // Savings reviews
      match /savingsReviews/{reviewId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) && notRateLimited();
      }
      
      // Agenda checklist
      match /agendaChecklist/{entryId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) && notRateLimited();
      }
      
      // Imported invoices tracking
      match /importedInvoices/{invoiceId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && notRateLimited();
        allow update: if isOwner(userId) && notRateLimited();
        allow delete: if isOwner(userId);
      }
      
      // Budget limits
      match /budgetLimits/{limitId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) && notRateLimited();
      }
      
      // Alerts
      match /alerts/{alertId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) && notRateLimited();
      }
      
      // Catch-all for any other subcollections
      match /{subcollection}/{document=**} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) && notRateLimited();
      }
    }
    
    // ============ Public Data (Read-Only) ============
    
    // Public configuration (app version, feature flags, etc.)
    match /public/{document=**} {
      allow read: if true;
      allow write: if false; // Only admin can write via Firebase Console
    }
    
    // ============ Deny All Other Access ============
    
    // Deny access to any other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
